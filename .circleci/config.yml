version: 2.1
orbs:
  docker: circleci/docker@2.0.1
  gradle: circleci/gradle@2.2.0

executors:
  access-backend-executor:
    docker:
      - image: cimg/openjdk:11.0
      - image: circleci/mongo:5.0.5
      - image: jboss/keycloak:16.1.0
        environment:
            KEYCLOAK_USER: admin
            KEYCLOAK_PASSWORD: admin
        command:
          - "-Djboss.bind.address=0.0.0.0"
          - "-Djboss.http.port=9999"

workflows:
  access-backend-workflow:      
    jobs:
      - gradle/test:
          executor: access-backend-executor
      - gradle/run:
          command: build sonarqube 
          executor: access-backend-executor
          context:
            - SonarCloud  # Contains the env variable SONAR_TOKEN
      - docker/publish:
          image: sealuzh/access-backend
          executor: access-backend-executor
          tag: $CIRCLE_BRANCH
          use-remote-docker: true